// Mock fixture data for demonstration
export const mockFixtures = [
  {
    id: 1,
    homeTeam: 'Manchester United',
    awayTeam: 'Arsenal',
    division: 'Premier League',
    venue: 'Old Trafford',
    location: 'Manchester, England',
    date: '2025-07-20',
    time: '15:00',
    city: 'manchester',
    coordinates: { lat: 53.4631, lng: -2.2914 }
  },
  {
    id: 2,
    homeTeam: 'Chelsea',
    awayTeam: 'Liverpool',
    division: 'Premier League',
    venue: 'Stamford Bridge',
    location: 'London, England',
    date: '2025-07-20',
    time: '17:30',
    city: 'london',
    coordinates: { lat: 51.4816, lng: -0.1909 }
  },
  {
    id: 3,
    homeTeam: 'Leicester City',
    awayTeam: 'Aston Villa',
    division: 'Premier League',
    venue: 'King Power Stadium',
    location: 'Leicester, England',
    date: '2025-07-20',
    time: '12:30',
    city: 'leicester',
    coordinates: { lat: 52.6205, lng: -1.1424 }
  },
  {
    id: 4,
    homeTeam: 'Tottenham',
    awayTeam: 'Crystal Palace',
    division: 'Premier League',
    venue: 'Tottenham Hotspur Stadium',
    location: 'London, England',
    date: '2025-07-20',
    time: '14:00',
    city: 'london',
    coordinates: { lat: 51.6042, lng: -0.0664 }
  },
  {
    id: 5,
    homeTeam: 'Brighton',
    awayTeam: 'West Ham',
    division: 'Premier League',
    venue: 'Amex Stadium',
    location: 'Brighton, England',
    date: '2025-07-20',
    time: '16:00',
    city: 'brighton',
    coordinates: { lat: 50.8609, lng: -0.0834 }
  },
  {
    id: 6,
    homeTeam: 'Leeds United',
    awayTeam: 'Sheffield United',
    division: 'Championship',
    venue: 'Elland Road',
    location: 'Leeds, England',
    date: '2025-07-20',
    time: '15:00',
    city: 'leeds',
    coordinates: { lat: 53.7776, lng: -1.5724 }
  },
  {
    id: 7,
    homeTeam: 'Norwich City',
    awayTeam: 'Burnley',
    division: 'Championship',
    venue: 'Carrow Road',
    location: 'Norwich, England',
    date: '2025-07-20',
    time: '15:00',
    city: 'norwich',
    coordinates: { lat: 52.6220, lng: 1.3089 }
  },
  {
    id: 8,
    homeTeam: 'Portsmouth',
    awayTeam: 'Oxford United',
    division: 'League One',
    venue: 'Fratton Park',
    location: 'Portsmouth, England',
    date: '2025-07-20',
    time: '15:00',
    city: 'portsmouth',
    coordinates: { lat: 50.7969, lng: -1.0638 }
  },
  // International Fixtures
  {
    id: 15,
    homeTeam: 'Real Madrid',
    awayTeam: 'Barcelona',
    division: 'La Liga',
    venue: 'Santiago Bernabéu',
    location: 'Madrid, Spain',
    date: '2025-07-20',
    time: '21:00',
    city: 'madrid',
    coordinates: { lat: 40.4530, lng: -3.6883 }
  },
  {
    id: 16,
    homeTeam: 'PSG',
    awayTeam: 'Marseille',
    division: 'Ligue 1',
    venue: 'Parc des Princes',
    location: 'Paris, France',
    date: '2025-07-20',
    time: '20:00',
    city: 'paris',
    coordinates: { lat: 48.8414, lng: 2.2531 }
  },
  {
    id: 17,
    homeTeam: 'Bayern Munich',
    awayTeam: 'Borussia Dortmund',
    division: 'Bundesliga',
    venue: 'Allianz Arena',
    location: 'Munich, Germany',
    date: '2025-07-20',
    time: '18:30',
    city: 'munich',
    coordinates: { lat: 48.2188, lng: 11.6242 }
  },
  {
    id: 18,
    homeTeam: 'AC Milan',
    awayTeam: 'Inter Milan',
    division: 'Serie A',
    venue: 'San Siro',
    location: 'Milan, Italy',
    date: '2025-07-20',
    time: '20:45',
    city: 'milan',
    coordinates: { lat: 45.4780, lng: 9.1240 }
  },
  // July 19, 2025 fixtures
  {
    id: 9,
    homeTeam: 'Liverpool',
    awayTeam: 'Manchester City',
    division: 'Premier League',
    venue: 'Anfield',
    location: 'Liverpool, England',
    date: '2025-07-19',
    time: '17:30',
    city: 'liverpool',
    coordinates: { lat: 53.4308, lng: -2.9608 }
  },
  {
    id: 10,
    homeTeam: 'Everton',
    awayTeam: 'Newcastle United',
    division: 'Premier League',
    venue: 'Goodison Park',
    location: 'Liverpool, England',
    date: '2025-07-19',
    time: '15:00',
    city: 'liverpool',
    coordinates: { lat: 53.4386, lng: -2.9663 }
  },
  {
    id: 11,
    homeTeam: 'Middlesbrough',
    awayTeam: 'Hull City',
    division: 'Championship',
    venue: 'Riverside Stadium',
    location: 'Middlesbrough, England',
    date: '2025-07-19',
    time: '15:00',
    city: 'middlesbrough',
    coordinates: { lat: 54.5784, lng: -1.2169 }
  },
  // July 21, 2025 fixtures
  {
    id: 12,
    homeTeam: 'Arsenal',
    awayTeam: 'Tottenham',
    division: 'Premier League',
    venue: 'Emirates Stadium',
    location: 'London, England',
    date: '2025-07-21',
    time: '16:30',
    city: 'london',
    coordinates: { lat: 51.5549, lng: -0.1084 }
  },
  {
    id: 13,
    homeTeam: 'West Ham',
    awayTeam: 'Fulham',
    division: 'Premier League',
    venue: 'London Stadium',
    location: 'London, England',
    date: '2025-07-21',
    time: '14:00',
    city: 'london',
    coordinates: { lat: 51.5387, lng: -0.0166 }
  },
  {
    id: 14,
    homeTeam: 'Sheffield Wednesday',
    awayTeam: 'Bristol City',
    division: 'Championship',
    venue: 'Hillsborough Stadium',
    location: 'Sheffield, England',
    date: '2025-07-21',
    time: '15:00',
    city: 'sheffield',
    coordinates: { lat: 53.4115, lng: -1.5006 }
  }
];

// Updated division/step/league structure to match new database
export const LEAGUE_STEP_MAP = [
  {
    step: 'Premier League',
    leagues: [
      { name: 'Premier League', id: '1' }
    ]
  },
  {
    step: 'Championship',
    leagues: [
      { name: 'Championship', id: '2' }
    ]
  },
  {
    step: 'League One',
    leagues: [
      { name: 'League One', id: '3' }
    ]
  },
  {
    step: 'League Two',
    leagues: [
      { name: 'League Two', id: '4' }
    ]
  },
  {
    step: 'National League',
    leagues: [
      { name: 'National League', id: '5' }
    ]
  },
  {
    step: 'Non-League Step 2',
    leagues: [
      { name: 'National League North', id: '6' },
      { name: 'National League South', id: '7' }
    ]
  },
  {
    step: 'Non-League Step 3',
    leagues: [
      { name: 'Northern Premier League - Premier Division', id: '14' },
      { name: 'Isthmian League - Premier Division', id: '11' },
      { name: 'Southern League - Premier Central', id: '8' },
      { name: 'Southern League - Premier South', id: '39' }
    ]
  },
  {
    step: 'Non-League Step 4',
    leagues: [
      { name: 'Northern Premier League - East Division', id: '15' },
      { name: 'Northern Premier League - Midlands Division', id: '114' },
      { name: 'Northern Premier League - West Division', id: '16' },
      { name: 'Isthmian League - North Division', id: '12' },
      { name: 'Isthmian League - South Central Division', id: '13' },
      { name: 'Isthmian League - South East Division', id: '40' },
      { name: 'Southern League - Central Division', id: '9' },
      { name: 'Southern League - South Division', id: '10' }
    ]
  },
  {
    step: 'Non-League Step 5',
    leagues: [
      { name: 'Combined Counties League Premier Division North', id: '117' },
      { name: 'Combined Counties League Premier Division South', id: '118' },
      { name: 'Essex Senior League', id: '123' },
      { name: 'Northern League Division One', id: '133' },
      { name: 'Northern Counties East League Premier Division', id: '131' },
      { name: 'Southern Counties East League Premier Division', id: '139' },
      { name: 'United Counties League Premier Division North', id: '143' },
      { name: 'United Counties League Premier Division South', id: '144' }
    ]
  },
  {
    step: 'Non-League Step 6',
    leagues: [
      { name: 'Combined Counties League Division One', id: '119' },
      { name: 'Northern League Division Two', id: '134' },
      { name: 'Northern Counties East League Division One', id: '132' },
      { name: 'Southern Counties East League First Division', id: '140' },
      { name: 'United Counties League Division One', id: '145' }
    ]
  }
];

// Returns an array for dropdown rendering: steps and their leagues
export function getDivisionOptions() {
  // Flat list: step, then each league under it
  const options = [
    { label: 'All Divisions', value: 'all', key: 'all' }
  ];
  LEAGUE_STEP_MAP.forEach(group => {
    options.push({ label: group.step, value: group.step, isStep: true, key: 'step-' + group.step });
    group.leagues.forEach(league => {
      options.push({ label: `- ${league.name}`, value: league.name, leagueId: league.id, parentStep: group.step, key: 'league-' + league.id });
    });
  });
  return options;
}

// Geographic bounds for England and Wales
const ENGLAND_WALES_BOUNDS = {
  north: 55.8,  // Northern England
  south: 49.9,  // Southern England
  west: -6.4,   // Western Wales
  east: 1.8     // Eastern England
};

// Function to check if coordinates are within England/Wales
const isWithinEnglandWales = (lat, lng) => {
  return lat >= ENGLAND_WALES_BOUNDS.south && 
         lat <= ENGLAND_WALES_BOUNDS.north && 
         lng >= ENGLAND_WALES_BOUNDS.west && 
         lng <= ENGLAND_WALES_BOUNDS.east;
};

// LocationIQ API configuration
const LOCATIONIQ_API_KEY = 'pk.a7e1a1ac97c584e3b3ecc7f43c06a67b';
const LOCATIONIQ_BASE_URL = 'https://us1.locationiq.com/v1/search';

// Cache for geocoding results
const geocodeCache = new Map();

// Cache management utilities
export const clearGeocodeCache = () => {
  geocodeCache.clear();
  console.log('Geocode cache cleared');
};

export const getCacheSize = () => {
  return geocodeCache.size;
};

export const getCacheStats = () => {
  console.log(`Geocode cache contains ${geocodeCache.size} entries:`);
  for (const [key, value] of geocodeCache.entries()) {
    console.log(`- "${key}": ${value.lat}, ${value.lng}`);
  }
};

// Real geocoding function using LocationIQ API with caching
export const geocodeLocation = async (location) => {
  if (!location || !location.trim()) {
    throw new Error('Please enter a location to search');
  }
  
  // Normalize the input
  const normalized = location.toLowerCase().trim();
  
  // Check cache first (fastest)
  if (geocodeCache.has(normalized)) {
    console.log(`Using cached result for "${location}"`);
    return geocodeCache.get(normalized);
  }
  
  // Check our mock database for exact matches (fast)
  if (locationCoordinates[normalized]) {
    const coords = locationCoordinates[normalized];
    geocodeCache.set(normalized, coords); // Cache the result
    return coords;
  }
  
  // Try LocationIQ API for real geocoding
  try {
    const encodedLocation = encodeURIComponent(location);
    const apiUrl = `${LOCATIONIQ_BASE_URL}?key=${LOCATIONIQ_API_KEY}&q=${encodedLocation}&format=json&limit=1&countrycodes=gb`;
    
    console.log(`Geocoding "${location}" using LocationIQ API...`);
    
    const response = await fetch(apiUrl);
    
    if (!response.ok) {
      if (response.status === 404) {
        throw new Error(`Location "${location}" not found. Please check the spelling and try again.`);
      }
      throw new Error(`Geocoding service error: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data && data.length > 0) {
      const result = data[0];
      const coordinates = {
        lat: parseFloat(result.lat),
        lng: parseFloat(result.lon) // Note: LocationIQ uses "lon" not "lng"
      };
      
      // Check if the location is within England/Wales bounds
      if (!isWithinEnglandWales(coordinates.lat, coordinates.lng)) {
        throw new Error(`"${location}" is outside England and Wales. Please enter a location within England or Wales.`);
      }
      
      console.log(`Found coordinates for "${location}":`, coordinates);
      console.log(`Full address: ${result.display_name}`);
      
      // Cache the successful result
      geocodeCache.set(normalized, coordinates);
      
      return coordinates;
    } else {
      throw new Error(`Location "${location}" not found. Please check the spelling and try again.`);
    }
    
  } catch (error) {
    console.error(`Geocoding failed for "${location}":`, error.message);
    
    // If it's already a user-friendly error, re-throw it
    if (error.message.includes('not found') || 
        error.message.includes('outside England') || 
        error.message.includes('Please enter')) {
      throw error;
    }
    
    // Try fallback to mock database partial matches
    const partialMatches = Object.keys(locationCoordinates).filter(key => 
      key.includes(normalized) || normalized.includes(key)
    );
    
    if (partialMatches.length > 0) {
      console.log(`Using fallback match: ${partialMatches[0]}`);
      const coords = locationCoordinates[partialMatches[0]];
      geocodeCache.set(normalized, coords); // Cache the fallback result
      return coords;
    }
    
    // No fallback available - throw error
    throw new Error(`Unable to find location "${location}". Please check the spelling or try a different location in England or Wales.`);
  }
};

export const distanceOptions = [
  { value: 5, label: 'Within 5 miles' },
  { value: 10, label: 'Within 10 miles' },
  { value: 25, label: 'Within 25 miles' },
  { value: 50, label: 'Within 50 miles' },
  { value: 100, label: 'Within 100 miles' }
];

// Map style options
export const mapStyles = [
  {
    id: 'light',
    name: 'Light',
    description: 'Clean and minimal',
    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd'
  },
  {
    id: 'dark',
    name: 'Dark',
    description: 'Modern dark theme',
    url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd'
  },
  {
    id: 'voyager',
    name: 'Voyager',
    description: 'Colorful and detailed',
    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd'
  },
  {
    id: 'satellite',
    name: 'Satellite',
    description: 'Aerial imagery',
    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    attribution: '© <a href="https://www.esri.com/">Esri</a>, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
  },
  {
    id: 'terrain',
    name: 'Terrain',
    description: 'Topographic with elevation',
    url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://opentopomap.org/">OpenTopoMap</a>',
    subdomains: 'abc'
  },
  {
    id: 'watercolor',
    name: 'Watercolor',
    description: 'Artistic watercolor style',
    url: 'https://stamen-tiles.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="http://stamen.com/">Stamen Design</a>'
  },
  {
    id: 'toner',
    name: 'Toner',
    description: 'High contrast black & white',
    url: 'https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="http://stamen.com/">Stamen Design</a>'
  },
  {
    id: 'osm',
    name: 'Street',
    description: 'Classic OpenStreetMap',
    url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }
];

// Mock location coordinates for distance calculation
export const locationCoordinates = {
  // UK Cities
  'manchester': { lat: 53.4794, lng: -2.2453 },
  'london': { lat: 51.5074, lng: -0.1278 },
  'birmingham': { lat: 52.4862, lng: -1.8904 },
  'leeds': { lat: 53.8008, lng: -1.5491 },
  'liverpool': { lat: 53.4084, lng: -2.9916 },
  'newcastle': { lat: 54.9783, lng: -1.6178 },
  'glasgow': { lat: 55.8642, lng: -4.2518 },
  'edinburgh': { lat: 55.9533, lng: -3.1883 },
  'cardiff': { lat: 51.4816, lng: -3.1791 },
  'bristol': { lat: 51.4545, lng: -2.5879 },
  
  // European Cities
  'paris': { lat: 48.8566, lng: 2.3522 },
  'madrid': { lat: 40.4168, lng: -3.7038 },
  'barcelona': { lat: 41.3851, lng: 2.1734 },
  'milan': { lat: 45.4642, lng: 9.1900 },
  'rome': { lat: 41.9028, lng: 12.4964 },
  'berlin': { lat: 52.5200, lng: 13.4050 },
  'munich': { lat: 48.1351, lng: 11.5820 },
  'amsterdam': { lat: 52.3676, lng: 4.9041 },
  'lisbon': { lat: 38.7223, lng: -9.1393 },
  
  // North American Cities
  'new york': { lat: 40.7128, lng: -74.0060 },
  'los angeles': { lat: 34.0522, lng: -118.2437 },
  'chicago': { lat: 41.8781, lng: -87.6298 },
  'toronto': { lat: 43.6532, lng: -79.3832 },
  'vancouver': { lat: 49.2827, lng: -123.1207 },
  
  // Other Major Cities
  'sydney': { lat: -33.8688, lng: 151.2093 },
  'melbourne': { lat: -37.8136, lng: 144.9631 },
  'tokyo': { lat: 35.6762, lng: 139.6503 },
  'singapore': { lat: 1.3521, lng: 103.8198 },
  
  // Postcodes (backwards compatibility)
  'M14BT': { lat: 53.4794, lng: -2.2453 },
  'M1 4BT': { lat: 53.4794, lng: -2.2453 },
  'SW1A1AA': { lat: 51.5014, lng: -0.1419 },
  'SW1A 1AA': { lat: 51.5014, lng: -0.1419 },
  'B11AA': { lat: 52.4862, lng: -1.8904 },
  'B1 1AA': { lat: 52.4862, lng: -1.8904 }
};

// Calculate distance between two coordinates using Haversine formula
export const calculateDistance = (lat1, lon1, lat2, lon2) => {
  const R = 3959; // Earth's radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}; 